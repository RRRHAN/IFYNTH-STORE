import React, { useRef, useState } from "react";
import {
  Dimensions,
  StyleSheet,
  ScrollView,
  TouchableOpacity,
} from "react-native";
import { LineChart } from "react-native-chart-kit";
import { ThemedView } from "@/components/ThemedView";
import { ThemedText } from "@/components/ThemedText";
import { TransactionReport } from "@/src/types/home";
import { useColorScheme } from "@/hooks/useColorScheme";

const screenWidth = Dimensions.get("window").width;

const getMaxVisibleData = (width: number) => {
  if (width < 401) return 4;
  if (width < 500) return 5;
  if (width < 600) return 6;
  if (width < 700) return 7;
  if (width < 800) return 9;
  if (width < 900) return 10;
  if (width < 1000) return 12;
  if (width < 1350) return 8;
  if (width < 1550) return 10;
  return 12;
};

const getMinWidth = (screenWidth: number) => {
  if (screenWidth > 1500) {
    return 880;
  } else if (screenWidth > 768) {
    return 600;
  } else {
    return 350;
  }
};

type TransactionChartProps = {
  transactionReport: TransactionReport[] | null;
  height?: number;
};

const TransactionReportChart: React.FC<TransactionChartProps> = ({
  transactionReport,
  height = 277,
}) => {
  const colorScheme = useColorScheme();
  const scrollRef = useRef<ScrollView>(null);

  const [tooltipData, setTooltipData] = useState<{
    value: number;
    x: number;
    y: number;
    date: string;
  } | null>(null);

  const labels = (transactionReport ?? []).map((r) => {
    const date = new Date(r.Date);
    const day = String(date.getDate()).padStart(2, "0");
    const month = String(date.getMonth() + 1).padStart(2, "0");
    const year = date.getFullYear();
    return `${day}-${month}-${year}`;
  });

  const data = (transactionReport ?? []).map((r) => r.TotalAmount / 1000);
  const actualTotalAmounts = (transactionReport ?? []).map(
    (r) => r.TotalAmount
  );

  const MAX_VISIBLE_DATA = getMaxVisibleData(screenWidth);
  const LABEL_WIDTH = 70;
  const MIN_WIDTH = getMinWidth(screenWidth);

  const visibleCount = Math.min(labels.length, MAX_VISIBLE_DATA);
  const scrollContentWidth = Math.max(labels.length * LABEL_WIDTH, MIN_WIDTH);

  const chartConfig = {
    backgroundColor: colorScheme === "dark" ? "#1c1c1c" : "#f0f0f0",
    backgroundGradientFrom: colorScheme === "dark" ? "#1c1c1c" : "#f0f0f0",
    backgroundGradientTo: colorScheme === "dark" ? "#1c1c1c" : "#f0f0f0",
    decimalPlaces: 0,
    color: (opacity = 1) => (colorScheme === "dark" ? "#ffffff" : "#111827"),
    labelColor: (opacity = 1) =>
      colorScheme === "dark" ? "#ffffff" : "#111827",
    style: {
      borderRadius: 16,
    },
    propsForDots: {
      r: "5",
      strokeWidth: "2",
      stroke: colorScheme === "dark" ? "#ffffff" : "#111827",
    },
  };

  const LABEL_COUNT = 5;
  const adjustedChartHeight = screenWidth > 1000 ? height - 25 : 250;
  const [productTableHeight, setProductTableHeight] = useState(0);
  const labelVerticalSpacing = productTableHeight / 6.3;

  return (
    <ThemedView
      style={[
        styles.container,
        { backgroundColor: colorScheme === "dark" ? "#1c1c1c" : "#f0f0f0" },
      ]}
      onLayout={(event) => {
        setProductTableHeight(event.nativeEvent.layout.height);
      }}
    >
      <ThemedText style={styles.title}>Transaction Report</ThemedText>
      <ThemedView
        style={{
          flexDirection: "row",
          backgroundColor: colorScheme === "dark" ? "#1c1c1c" : "#f0f0f0",
        }}
      >
        <ThemedView
          style={[
            styles.yAxisContainer,
            { backgroundColor: colorScheme === "dark" ? "#1c1c1c" : "#f0f0f0" },
          ]}
        >
          {[...Array(LABEL_COUNT)].map((_, i) => {
            const max = Math.max(...data);
            const yValue =
              data.length > 0
                ? Math.round((max / (LABEL_COUNT - 1)) * (LABEL_COUNT - 1 - i))
                : 0;

            const labelStyle: any = { ...styles.yAxisLabel };
            if (i === 0) {
              labelStyle.paddingTop = 4;
            } else if (i === LABEL_COUNT - 1) {
              labelStyle.paddingBottom = labelVerticalSpacing;
            } else {
            }

            return (
              <ThemedText key={i} style={labelStyle}>
                {yValue}k
              </ThemedText>
            );
          })}
        </ThemedView>

        {/* Chart with horizontal scroll */}
        <ScrollView
          horizontal
          showsHorizontalScrollIndicator={true}
          contentContainerStyle={{
            width: scrollContentWidth,
          }}
          ref={scrollRef}
          onContentSizeChange={() => {
            if (scrollRef.current) {
              scrollRef.current.scrollToEnd({ animated: true });
            }
          }}
        >
          <LineChart
            data={{
              labels,
              datasets: [{ data }],
            }}
            width={scrollContentWidth}
            height={adjustedChartHeight}
            yAxisSuffix="k"
            yAxisInterval={1}
            chartConfig={chartConfig}
            bezier
            style={styles.chart}
            fromZero
            withHorizontalLabels={false}
            onDataPointClick={({ value, index, x, y }) => {
              setTooltipData({
                value: actualTotalAmounts[index],
                x: x,
                y: y,
                date: labels[index],
              });
            }}
          />
          {tooltipData && (
            <ThemedView
              style={[
                styles.tooltipContainer,
                {
                  left: tooltipData.x,
                  top: tooltipData.y,
                },
              ]}
            >
              <ThemedText style={styles.tooltipText}>
                {tooltipData.date}: Rp
                {tooltipData.value.toLocaleString("id-ID")}
              </ThemedText>
              <TouchableOpacity
                onPress={() => setTooltipData(null)}
                style={styles.closeTooltipButton}
              >
                <ThemedText style={styles.closeTooltipText}>X</ThemedText>
              </TouchableOpacity>
            </ThemedView>
          )}
        </ScrollView>
      </ThemedView>
    </ThemedView>
  );
};

const styles = StyleSheet.create({
  container: {
    borderRadius: 20,
  },
  chart: {
    borderRadius: 20,
  },
  title: {
    fontSize: 24,
    fontWeight: "bold",
    textAlign: "center",
    marginBottom: 20,
    marginTop: 10,
  },
  yAxisContainer: {
    width: 40,
    justifyContent: "space-between",
    marginRight: 2,
  },
  yAxisLabel: {
    fontSize: 12,
    color: "#6b7280",
    textAlign: "right",
  },
  tooltipContainer: {
    position: "absolute",
    backgroundColor: "rgba(0,0,0,0.8)",
    borderRadius: 8,
    paddingVertical: 6,
    paddingHorizontal: 10,
    zIndex: 100,
    flexDirection: "row",
    alignItems: "center",
    gap: 5,
  },
  tooltipText: {
    color: "#fff",
    fontSize: 12,
    fontWeight: "bold",
  },
  closeTooltipButton: {
    marginLeft: 8,
    paddingHorizontal: 5,
    paddingVertical: 2,
    borderRadius: 10,
    backgroundColor: "rgba(255,255,255,0.2)",
  },
  closeTooltipText: {
    color: "#fff",
    fontSize: 10,
    fontWeight: "bold",
  },
});

export default TransactionReportChart;
